# Building the code

Use the `Makefile` to build locally.
```shell
make
```

# Docker

Sample out-of-the-box docker-compose setupus can be found in `config/examples`.

## Building the docker image

You can build the YABA docker image by running the following command in the project root directory:
```shell
make docker
```


You may consider the following flags for debugging
```shell
docker build --tag wenbenz/yaba --progress plain --no-cache .
```

The `Dockerfile` configures the image to bind bind to port 9222.

# DB Migrations

This project uses [go-migrate](https://github.com/golang-migrate/migrate) to manage migrations.
To run migrations, you'll to be able to connect to the postgres instance using a connection string.

```shell
# build a connection string
export POSTGRES_USER="yaba"
export POSTGRES_PASSWORD=$(cat db_password.txt)
export POSTGRES_URL="postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:5432/yaba?sslmode=disable"
```

Apply all migrations by running
```shell
migrate -database ${POSTGRES_URL} -path migrations up
```

Apply a single migration
```shell
migrate -database ${POSTGRES_URL} -path migrations up 1
```

Roll back a single migration
```shell
migrate -database ${POSTGRES_URL} -path server/migrations down 1
```

## Adding database migrations

To create a migration, run
```shell
migrate create -ext sql -dir migrations -seq MIGRATION_NAME
```

Then fill in the generated SQL files in `migrations`.

## GraphQL

### Server
This repo uses `github.com/99designs/gqlgen` to generate graphql schemas.
Changes to the schema can be made in `graph/schema.graphqls` and generated by running
```shell
go run github.com/99designs/gqlgen generate
```
This should add boilerplate changes to `graph/schema.resolvers.go`. Implement the new methods there.

### Client
This repo also uses `github.com/Khan/genqlient` to create clients that are used for tests.
Clients are generated from queries in `graph/client/genqlient.graphql` by running
```shell
go run github.com/Khan/genqlient genqlient.yaml
```

Sadly, the generated code is bad for code coverage. Oh well.
